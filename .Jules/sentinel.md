## 2024-05-22 - Overly Restrictive RBAC Blocking Functional Requirements
**Vulnerability:** The `users` collection in Firestore had strict RBAC that only allowed Admins to update user documents. However, the client-side application logic required regular users (employees) to update their own documents to save FCM tokens for push notifications (`updateUserFCMToken`). This created a functional denial of service where notifications failed for non-admin users.
**Learning:** Security rules must balance protection with functionality. Simply blocking all updates for non-admins is too coarse when users need to maintain parts of their own profile (like device tokens).
**Prevention:** Use granular field-level permission checks. Instead of `allow update: if false`, use `allow update: if isOwner() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['safeField1', 'safeField2'])` to permit specific safe updates without exposing sensitive fields like `role` to modification.
